<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Config Flags</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    caption { font-size: 1.5em; margin-bottom: 1em; }
  </style>
</head>
<body>
  <h1>Config Flags</h1>
  <a href="/configs.html">All Configs</a>
  <a href="/overrides.html">Config Overrides</a>
  <table id="configTable">
    <caption>All Config Flags and Values</caption>
    <thead>
      <tr>
        <th>Service</th>
        <th>Name</th>
        <th>Type</th>
        <th>Default Value</th>
      </tr>
    </thead>
    <tbody>
      <!-- Config rows will be inserted here -->
    </tbody>
  </table>
  <script>
    const configServiceHost = 'http://localhost:8080';

    // Helper to create collapsible rows
    function createCollapsibleRow(service, configs) {
      const tbody = document.createDocumentFragment();

      // Service header row
      const serviceRow = document.createElement('tr');
      serviceRow.className = 'service-row';
      serviceRow.style.background = '#e9e9e9';
      serviceRow.style.cursor = 'pointer';

      const td = document.createElement('td');
      td.colSpan = 4;
      td.innerHTML = `<span class="toggle" style="font-weight:bold;">&#9654;</span> ${service}`;
      serviceRow.appendChild(td);

      tbody.appendChild(serviceRow);

      // Config rows (hidden by default)
      configs.forEach(cfg => {
        const row = document.createElement('tr');
        row.className = `config-row config-of-${service.replace(/[^a-zA-Z0-9]/g, '_')}`;
        row.style.display = 'none';
        row.innerHTML = `
          <td></td>
          <td>
            ${cfg.name}
            <a href="overrides.html?service=${encodeURIComponent(cfg.service)}&config=${encodeURIComponent(cfg.name)}" style="margin-left:8px;font-size:0.9em;">View Overrides</a>
          </td>
          <td>${cfg.type}</td>
          <td>${cfg.defaultValue}</td>
        `;
        tbody.appendChild(row);
      });

      // Toggle logic
      serviceRow.onclick = function() {
        const rows = document.querySelectorAll(`.config-of-${service.replace(/[^a-zA-Z0-9]/g, '_')}`);
        const toggleIcon = serviceRow.querySelector('.toggle');
        const isOpen = toggleIcon.textContent === '▼';
        rows.forEach(r => r.style.display = isOpen ? 'none' : '');
        toggleIcon.textContent = isOpen ? '►' : '▼';
      };

      return tbody;
    }

    async function loadConfigs() {
      try {
        const response = await fetch(`${configServiceHost}/configs`);
        if (!response.ok) throw new Error('Failed to fetch configs');
        const data = await response.json();
        const configs = data.configs || [];
        const tbody = document.querySelector('#configTable tbody');
        tbody.innerHTML = '';

        // Group configs by service
        const grouped = {};
        configs.forEach(cfg => {
          if (!grouped[cfg.service]) grouped[cfg.service] = [];
          grouped[cfg.service].push(cfg);
        });

        // Insert collapsible groups
        Object.keys(grouped).sort().forEach(service => {
          tbody.appendChild(createCollapsibleRow(service, grouped[service]));
        });
      } catch (err) {
        document.body.innerHTML += '<p style="color:red;">Error loading configs: ' + err.message + '</p>';
      }
    }
    window.onload = loadConfigs;
  </script>
</body>
</html>